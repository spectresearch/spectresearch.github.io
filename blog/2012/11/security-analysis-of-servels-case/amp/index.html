<head>
    <meta charset="utf-8">

    <title>Security analysis of Servel's case</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="http://spect.cl/blog/2012/11/security-analysis-of-servels-case/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="SPECT Research">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Security analysis of Servel's case">
    <meta property="og:description" content="A lot of time ago, there was an incident related to citizenship privacy in Chile and many people, even from other countries, published some posts about it [1][2][3]. Today, with all citizen data made public due to an important lack of awareness about privacy and security, I'll describe">
    <meta property="og:url" content="http://spect.cl/blog/2012/11/security-analysis-of-servels-case/">
    <meta property="article:published_time" content="2012-11-21T12:00:00.000Z">
    <meta property="article:modified_time" content="2015-09-10T09:19:05.000Z">
    <meta property="article:tag" content="security">
    <meta property="article:tag" content="review">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Security analysis of Servel's case">
    <meta name="twitter:description" content="A lot of time ago, there was an incident related to citizenship privacy in Chile and many people, even from other countries, published some posts about it [1][2][3]. Today, with all citizen data made public due to an important lack of awareness about privacy and security, I'll describe">
    <meta name="twitter:url" content="http://spect.cl/blog/2012/11/security-analysis-of-servels-case/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Claudio Salazar">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="security, review">
    <meta name="twitter:site" content="@spectresearch">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "SPECT Research",
        "logo": {
            "@type": "ImageObject",
            "url": "http://spect.cl/favicon.ico",
            "width": 16,
            "height": 16
        }
    },
    "author": {
        "@type": "Person",
        "name": "Claudio Salazar",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/134e22ab3b4cac1e783f88f84917bc12?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://spect.cl/author/claudio/",
        "sameAs": []
    },
    "headline": "Security analysis of Servel&#x27;s case",
    "url": "http://spect.cl/blog/2012/11/security-analysis-of-servels-case/",
    "datePublished": "2012-11-21T12:00:00.000Z",
    "dateModified": "2015-09-10T09:19:05.000Z",
    "keywords": "security, review",
    "description": "A lot of time ago, there was an incident related to citizenship privacy in Chile and many people, even from other countries, published some posts about it [1][2][3]. Today, with all citizen data made public due to an important lack of awareness about privacy and security, I&#x27;ll describe",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://spect.cl/"
    }
}
    </script>

    <meta name="generator" content="Ghost 1.16">
    <link rel="alternate" type="application/rss+xml" title="SPECT Research" href="http://spect.cl/rss/">

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,600,400">
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="http://spect.cl">SPECT Research</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Security analysis of Servel's case</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/claudio/">Claudio Salazar</a></p>
                    <time class="post-date" datetime="2012-11-21">2012-11-21</time>
                </section>
            </header>
            <section class="post-content">

                <div class="kg-card-markdown"><p>A lot of time ago, there was an incident related to citizenship privacy in Chile and many people, even from other countries, published some posts about it <a href="http://blog.secureless.org/data-leak/los-datos-de-13-millones-de-chilenos-disponibles-en-la-red-tor/">[1]</a><a href="http://zaufanatrzeciastrona.pl/post/wyciek-danych-wszystkich-wyborcow-czyli-jak-nie-udostepniac-rzadowych-baz-danych/">[2]</a><a href="http://blog.secureless.org/data-leak/links-para-descargar-los-archivos-pdf-con-datos-de-13-millones-de-chilenos/">[3]</a>. Today, with all citizen data made public due to an important lack of awareness about privacy and security, I'll describe the weak patch implemented at Servel's page to avoid massive requests of citizen information. This was a <em>CAPTCHA</em> solution which I broke by two methods: a logic flaw and a design weakness.</p>
<p>In SPECT Research we aren't used to make public vulnerabilities in web sites, but we have a strong commitment with the citizenship and the issues affecting their privacy. In this case, even my information was compromised. I think the vulnerabilities explained here are harmless, since all citizen information extracted from Servel's site is available in networks like Tor or direct download, as it's mentioned in referenced posts.</p>

<h2 id="asimpleflawinthelogiccaptchabypass">A simple flaw in the logic: CAPTCHA bypass</h2>
<p>First three queries to <a href="http://consulta.servel.cl/">Servel's page</a> with a valid <em>RUN</em> doesn't require <em>CAPTCHA</em> solution. After that, a <em>CAPTCHA</em> is displayed and you need to answer it correctly in order to get citizen information. But what if instead of answering this new form with new fields you replay previous requests?</p>
<p>I think this flaw in the logic was implemented by staff in charge of the web site. After three queries, the <em>CAPTCHA</em> is displayed but this new form isn't enforced. You can use previous requests, change the <em>RUN</em> and get citizen information, bypassing the <em>CAPTCHA</em>.</p>
<h2 id="from625to100ofsuccessincaptchasolving">From 62.5% to 100% of success in CAPTCHA solving</h2>
<p>In late April this year, I published a <a href="http://www.youtube.com/watch?v=1NqOWSqPHX0">video</a> solving the <em>CAPTCHA</em> present in Servel's page with a 62.5% of success guessing the numbers of the <em>CAPTCHA</em>. After that, I did a little research to improve this percentage based on the first work.</p>
<p>The software used by Servel's page was <a href="http://www.brainjar.com/dotnet/captchaimage/default2.asp">CAPTCHA Image</a>. Its source code is available so you can check how <em>CAPTCHA</em>s are created. The initial version of the <em>CAPTCHA</em> solver script did the following steps on the <em>CAPTCHA</em> image:</p>
<ol>
<li>
<p>Use <em>convert</em> utility (from ImageMagick) to apply a Difference of Gaussian (DoG) filter to the image. This was the best filter to highlight borders of the image.</p>
</li>
<li>
<p>Use <a href="https://code.google.com/p/pytesser/">pytesser</a> (a python wrapper for Tesseract) to read the numbers from the image. I did some modifications on the code to run the script.</p>
</li>
</ol>
<p>With that approach, I got 62.5% of success, so the next step was thinking ideas to improve the results. I thought about improving clarity of the numbers in the image, through application of new filters. This was a difficult way since the noise in the background is always present and the filters could get confused, so image clarity wouldn't improve in the expected manner.<br>
After that closed door, I thought about flaws in the logic of <em>CAPTCHA Image</em>. As it's explained in its <a href="http://www.brainjar.com/dotnet/captchaimage/default2.asp">web site</a>, the workflow is the following:</p>
<ol>
<li>CAPTCHA Image generates a random text</li>
<li>It stores the text in the Session object (<code>Session["CaptchaImageText"]</code>)</li>
<li>It creates the CAPTCHA image using <code>Session["CaptchaImageText"]</code></li>
<li>Finally, it validates the user input against <code>Session["CaptchaImageText"]</code></li>
</ol>
<p>The page in charge of this handling is <em>Default.aspx.cs</em>, specifically the method <code>Page_Load()</code>, displayed next:</p>
<pre><code class="language-language-csharp">
private void Page_Load(object sender, System.EventArgs e)
{
  if (!this.IsPostBack)

    // Create a random code and store it in the Session object.
    this.Session["CaptchaImageText"] = GenerateRandomCode();

  else
  {
    // On a postback, check the user input.
    if (this.CodeNumberTextBox.Text == this.Session["CaptchaImageText"].ToString())
    {
      // Display an informational message.
      this.MessageLabel.CssClass = "info";
      this.MessageLabel.Text = "Correct!";
    }
    else
    {
      // Display an error message.
      this.MessageLabel.CssClass = "error";
      this.MessageLabel.Text = "ERROR: Incorrect, try again.";

      // Clear the input and create a new random code.
      this.CodeNumberTextBox.Text = "";
      this.Session["CaptchaImageText"] = GenerateRandomCode();
    }
  }
}
</code></pre>
<p>At the first request (a <code>GET</code> request), the condition at line 3 is <code>True</code> then <em>CAPTCHA</em> text is generated and related to your session. In other case, if it's a valid <a href="http://msdn.microsoft.com/en-us/library/system.web.ui.page.ispostback(v=vs.71).aspx">PostBack</a> request then the user input is validated as right or wrong.<br>
It seems like if you correctly answer the <em>CAPTCHA</em>, the variable <code>Session["CaptchaImageText"]</code> is never cleaned, then you could request over and over successfully using the same initial <em>CAPTCHA</em> solution, but it's not true in practice. I don't know if they added some countermeasure for that or the same <em>CAPTCHA Image</em> made some call to generate another random text.</p>
<p>Recalling from <em>CAPTCHA Image</em> workflow, at point 3 the CAPTCHA image is generated from <code>Session["CaptchaImageText"]</code> in page <code>JpegImage.aspx</code>. Looking at the code in <code>Default.aspx.cs</code>, if you made a bad guess the <em>CAPTCHA</em> text is regenerated. Otherwise, it's kept. You can generate infinite images requesting <code>JpegImage.aspx</code> with the same <code>Session["CaptchaImageText"]</code> and all images will have the same number. This, combined with my first script, is the new approach.</p>
<p>The script fails when it can't correctly guess the text in the image. It's due to the fact that some <em>CAPTCHA</em> images have much noise, or their rotation values are high and the texts are very distorted. But if you can generate many images, some of them will be guessed well. In this case, the success of the script is 62.5%, so I could request five images, if three of them match the same guess, I could confirm with around 100% of accuracy that the guess was right.</p>
<p>A video showing <em>CAPTCHA Image</em> solver running is shown next:</p>
<amp-iframe width="560" height="315" src="https://www.youtube.com/embed/D_9zj9X9j6U?rel=0" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin" layout="responsive"></amp-iframe>
<p>The source code of <em>CAPTCHA Image</em> solver is available <a href="https://github.com/spectresearch/captcha_image_solver">here</a>.</p>
</div>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="http://spect.cl">SPECT Research</a> © 2017</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
